<html>

<head>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://unpkg.com/gifuct-js/dist/gifuct.min.js"></script>
</head>

<body>
  <a-scene embedded arjs="patternRatio:0.9">
    <a-marker type="pattern" url="./assets/pattern-marker.patt">
      <a-plane id="gifPlane" position="0 0 0" rotation="-90 0 0" width="2" height="2"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const gifImg = document.getElementById('gif1');

    gifImg.onload = async () => {
      // GIFをArrayBufferとして取得
      const response = await fetch(gifImg.src);
      const arrayBuffer = await response.arrayBuffer();

      // gifuct-jsでデコード
      const gif = new window.GIF(arrayBuffer);
      const frames = gif.decompressFrames(true); // trueで透明部分も考慮

      // Canvas作成
      const canvas = document.createElement('canvas');
      canvas.width = frames[0].dims.width;
      canvas.height = frames[0].dims.height;
      const ctx = canvas.getContext('2d');

      // A-Frame planeにcanvasを貼る
      const plane = document.querySelector('#gifPlane');
      plane.setAttribute('material', 'src', canvas);

      // GIFフレームループ再生
      let currentFrame = 0;
      function animateFrame() {
        const frame = frames[currentFrame];

        // ImageDataに変換して描画
        const imageData = ctx.createImageData(frame.dims.width, frame.dims.height);
        imageData.data.set(frame.patch);
        ctx.putImageData(imageData, frame.dims.left, frame.dims.top);

        plane.getObject3D('mesh').material.map.needsUpdate = true;

        // 次のフレーム
        currentFrame = (currentFrame + 1) % frames.length;

        // フレーム遅延に従ってループ
        setTimeout(animateFrame, frame.delay || 100); // delayは1/100秒単位
      }

      animateFrame();
    };
  </script>

</body>

</html>
